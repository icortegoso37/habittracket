<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="H√°bitos">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<title>H√°bitos</title>
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<style>
:root{--bg:#0a0a0a;--bg2:#141414;--bg3:#1e1e1e;--txt:#fff;--txt2:#a0a0a0;--txt3:#666;--brd:#2a2a2a;--blue:#00d4ff;--green:#00ff88;--yellow:#ffee00;--orange:#ff8800;--pink:#ff00aa;--red:#ff3366;--gray:#333;--sat:env(safe-area-inset-top,47px);--sab:env(safe-area-inset-bottom,34px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--txt);line-height:1.5}
.app{display:flex;flex-direction:column;height:100%;max-width:430px;margin:0 auto;padding-top:var(--sat)}
.score-hdr{background:linear-gradient(var(--bg),var(--bg2));padding:12px 20px 16px;text-align:center;border-bottom:1px solid var(--brd)}
.score-box{display:flex;align-items:center;justify-content:center;gap:16px}
.score-circle{width:70px;height:70px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;position:relative}
.score-circle::before{content:'';position:absolute;inset:4px;background:var(--bg);border-radius:50%}
.score-val{position:relative;z-index:1}
.score-info{text-align:left}
.score-lbl{font-size:.7rem;color:var(--txt3);text-transform:uppercase;letter-spacing:1px}
.score-date{font-size:1rem;font-weight:600}
.score-streak{font-size:.8rem;color:var(--orange);display:flex;align-items:center;gap:4px;margin-top:2px}
.main{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.view{display:none;padding:16px;animation:fadeIn .3s}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
.nav{display:flex;justify-content:space-around;background:var(--bg2);border-top:1px solid var(--brd);padding:8px 0 calc(8px + var(--sab))}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 12px;border:none;background:none;cursor:pointer}
.nav-icon{width:26px;height:26px;opacity:.5}
.nav-item span{font-size:.65rem;color:var(--txt3)}
.nav-item.active .nav-icon{opacity:1}
.nav-item.active span{color:var(--txt)}
.day-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px}
.day-btn{width:36px;height:36px;border-radius:50%;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);font-size:1.1rem;cursor:pointer}
.day-title{text-align:center}
.day-title h2{font-size:1.1rem;font-weight:600}
.day-title p{font-size:.8rem;color:var(--txt2)}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.stat-card{background:var(--bg2);border-radius:12px;padding:12px;text-align:center;border:1px solid var(--brd)}
.stat-val{font-size:1.3rem;font-weight:700;color:var(--blue)}
.stat-lbl{font-size:.65rem;color:var(--txt3);text-transform:uppercase;margin-top:2px}
.stat-card.good .stat-val{color:var(--green)}
.stat-card.bad .stat-val{color:var(--red)}
.habit-list{display:flex;flex-direction:column;gap:10px}
.habit-card{background:var(--bg2);border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--brd)}
.habit-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.habit-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;box-shadow:0 0 8px currentColor}
.habit-details{min-width:0}
.habit-name{font-size:.95rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.habit-meta{display:flex;align-items:center;gap:8px;margin-top:2px}
.habit-badge{font-size:.6rem;padding:2px 5px;border-radius:4px;text-transform:uppercase}
.habit-badge.inc{background:rgba(0,255,136,.15);color:var(--green)}
.habit-badge.red{background:rgba(255,51,102,.15);color:var(--red)}
.habit-streak{font-size:.65rem;color:var(--orange)}
.habit-goal{font-size:.65rem;color:var(--txt3)}
.habit-goal.done{color:var(--green)}
.habit-counter{display:flex;align-items:center;gap:10px}
.cnt-btn{width:36px;height:36px;border-radius:50%;border:2px solid var(--brd);background:var(--bg3);color:var(--txt);font-size:1.3rem;cursor:pointer}
.cnt-btn.plus{border-color:var(--green);color:var(--green)}
.cnt-btn.minus{border-color:var(--red);color:var(--red)}
.cnt-val{font-size:1.4rem;font-weight:700;min-width:36px;text-align:center}
.empty{text-align:center;padding:50px 20px;color:var(--txt2)}
.empty-icon{font-size:2.5rem;margin-bottom:12px;opacity:.5}
.empty h3{font-size:1rem;margin-bottom:6px;color:var(--txt)}
.empty p{font-size:.85rem;margin-bottom:16px}
.btn{background:var(--blue);color:var(--bg);border:none;padding:12px 24px;border-radius:12px;font-size:.95rem;font-weight:600;cursor:pointer}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.cal-btn{width:36px;height:36px;border-radius:50%;border:1px solid var(--brd);background:var(--bg2);color:var(--txt);font-size:1.1rem;cursor:pointer}
.cal-title{font-size:1rem;font-weight:600}
.heatmap{background:var(--bg2);border-radius:12px;padding:12px;border:1px solid var(--brd);overflow-x:auto}
.hm-week{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:6px}
.hm-lbl{font-size:.6rem;color:var(--txt3);text-align:center}
.hm-grid{display:grid;gap:3px}
.hm-grid.week{grid-template-columns:repeat(7,1fr)}
.hm-grid.month{grid-template-columns:repeat(7,1fr)}
.hm-grid.year{grid-template-columns:repeat(53,1fr)}
.hm-cell{aspect-ratio:1;border-radius:3px;min-width:12px;min-height:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.5rem;font-weight:600}
.hm-cell.empty{background:var(--bg3);opacity:.3}
.hm-cell.future{background:transparent;border:1px dashed var(--brd);opacity:.2}
.hm-cell.nodata{background:var(--gray)}
.hm-grid.year .hm-cell{min-width:8px;min-height:8px;font-size:0;border-radius:2px}
.yr-months{display:flex;justify-content:space-between;margin-bottom:8px}
.yr-month{font-size:.55rem;color:var(--txt3)}
.habit-hm{margin-bottom:16px}
.habit-hm-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.habit-hm-hdr .habit-dot{width:8px;height:8px}
.habit-hm-hdr .habit-name{font-size:.85rem;font-weight:500}
.set-sec{margin-bottom:24px}
.set-sec h3{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--txt3);margin-bottom:10px}
.set-list{display:flex;flex-direction:column;gap:8px}
.set-item{background:var(--bg2);border-radius:12px;padding:14px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--brd);cursor:pointer}
.set-item-info{display:flex;align-items:center;gap:12px}
.set-item-color{width:18px;height:18px;border-radius:50%;box-shadow:0 0 8px currentColor}
.set-item-details h4{font-size:.9rem;font-weight:500;margin-bottom:2px}
.set-item-details p{font-size:.7rem;color:var(--txt2)}
.set-item-action{color:var(--txt3);font-size:1rem}
.add-btn{width:100%;padding:14px;border-radius:12px;border:2px dashed var(--brd);background:transparent;color:var(--txt2);font-size:.9rem;cursor:pointer;margin-top:10px}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:flex-end;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:.3s}
.modal-bg.active{opacity:1;visibility:visible}
.modal{background:var(--bg2);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + var(--sab));width:100%;max-width:430px;max-height:85vh;overflow-y:auto;transform:translateY(100%);transition:transform .3s}
.modal-bg.active .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--brd);border-radius:2px;margin:0 auto 16px}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-hdr h2{font-size:1.1rem;font-weight:600}
.modal-close{width:28px;height:28px;border-radius:50%;border:none;background:var(--bg3);color:var(--txt2);font-size:1rem;cursor:pointer}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.75rem;color:var(--txt2);margin-bottom:6px}
.form-group input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--brd);background:var(--bg3);color:var(--txt);font-size:.9rem}
.color-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.color-opt{aspect-ratio:1;border-radius:50%;border:3px solid transparent;cursor:pointer;box-shadow:0 0 10px currentColor}
.color-opt.sel{border-color:var(--txt);transform:scale(1.1)}
.type-sel{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.type-opt{padding:12px;border-radius:10px;border:2px solid var(--brd);background:var(--bg3);cursor:pointer;text-align:center}
.type-opt.sel{border-color:var(--blue);background:rgba(0,212,255,.1)}
.type-opt-icon{font-size:1.2rem;margin-bottom:4px}
.type-opt-lbl{font-size:.8rem;font-weight:500}
.type-opt-desc{font-size:.65rem;color:var(--txt2);margin-top:2px}
.form-actions{display:flex;gap:8px;margin-top:20px}
.form-actions button{flex:1;padding:12px;border-radius:10px;font-size:.9rem;font-weight:600;cursor:pointer}
.btn-sec{background:var(--bg3);border:1px solid var(--brd);color:var(--txt)}
.btn-del{background:rgba(255,51,102,.15);border:1px solid var(--red);color:var(--red)}
.chk-grp{display:flex;align-items:center;gap:10px}
.chk-grp input[type="checkbox"]{width:18px;height:18px;accent-color:var(--blue)}
.chk-grp label{margin-bottom:0;font-size:.85rem}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg3);color:var(--txt);padding:10px 20px;border-radius:10px;font-size:.8rem;opacity:0;transition:.3s;z-index:2000}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:.2s}
.confirm-modal.active{opacity:1;visibility:visible}
.confirm-box{background:var(--bg2);border-radius:16px;padding:24px;width:90%;max-width:300px;text-align:center}
.confirm-box h3{font-size:1rem;margin-bottom:8px}
.confirm-box p{font-size:.85rem;color:var(--txt2);margin-bottom:20px}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:12px;border-radius:10px;font-size:.9rem;font-weight:600;cursor:pointer;border:none}
.confirm-btns .cancel{background:var(--bg3);color:var(--txt)}
.confirm-btns .danger{background:var(--red);color:#fff}
</style>
</head>
<body>
<div class="app">
<div class="score-hdr">
<div class="score-box">
<div class="score-circle" id="scoreCircle"><span class="score-val" id="scoreVal">0</span></div>
<div class="score-info">
<div class="score-lbl">Puntuaci√≥n</div>
<div class="score-date" id="scoreDate">Hoy</div>
<div class="score-streak">üî• <span id="gStreak">0 d√≠as</span></div>
</div>
</div>
</div>
<main class="main">
<section id="viewDay" class="view active"></section>
<section id="viewWeek" class="view"></section>
<section id="viewMonth" class="view"></section>
<section id="viewYear" class="view"></section>
<section id="viewSettings" class="view"></section>
</main>
<nav class="nav">
<button class="nav-item active" data-view="viewDay">
<svg class="nav-icon" style="color:#00aaff" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="3" y1="9" x2="21" y2="9"/><polyline points="8 13 10 15 15 10" stroke-linecap="round" stroke-linejoin="round"/></svg>
<span>D√≠as</span>
</button>
<button class="nav-item" data-view="viewWeek">
<svg class="nav-icon" style="color:#00ff88" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="3" y1="9" x2="21" y2="9"/><circle cx="8" cy="13" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="13" r="1" fill="currentColor" stroke="none"/><circle cx="16" cy="13" r="1" fill="currentColor" stroke="none"/><circle cx="8" cy="17" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="17" r="1" fill="currentColor" stroke="none"/><circle cx="16" cy="17" r="1" fill="currentColor" stroke="none"/></svg>
<span>Semanas</span>
</button>
<button class="nav-item" data-view="viewMonth">
<svg class="nav-icon" style="color:#ffee00" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="3"/><line x1="3" y1="9" x2="21" y2="9"/><circle cx="7" cy="12.5" r=".8" fill="currentColor" stroke="none"/><circle cx="10.3" cy="12.5" r=".8" fill="currentColor" stroke="none"/><circle cx="13.7" cy="12.5" r=".8" fill="currentColor" stroke="none"/><circle cx="17" cy="12.5" r=".8" fill="currentColor" stroke="none"/><circle cx="7" cy="15.5" r=".8" fill="currentColor" stroke="none"/><circle cx="10.3" cy="15.5" r=".8" fill="currentColor" stroke="none"/><circle cx="13.7" cy="15.5" r=".8" fill="currentColor" stroke="none"/><circle cx="17" cy="15.5" r=".8" fill="currentColor" stroke="none"/><circle cx="7" cy="18.5" r=".8" fill="currentColor" stroke="none"/><circle cx="10.3" cy="18.5" r=".8" fill="currentColor" stroke="none"/><circle cx="13.7" cy="18.5" r=".8" fill="currentColor" stroke="none"/><circle cx="17" cy="18.5" r=".8" fill="currentColor" stroke="none"/></svg>
<span>Meses</span>
</button>
<button class="nav-item" data-view="viewYear">
<svg class="nav-icon" style="color:#ff8800" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="4" y="9" width="16" height="6" rx="3"/></svg>
<span>A√±os</span>
</button>
<button class="nav-item" data-view="viewSettings">
<svg class="nav-icon" style="color:#ff00aa" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v3m0 16v3M4.22 4.22l2.12 2.12m11.32 11.32l2.12 2.12M1 12h3m16 0h3M4.22 19.78l2.12-2.12m11.32-11.32l2.12-2.12"/></svg>
<span>Ajustes</span>
</button>
</nav>
</div>
<div class="modal-bg" id="modalBg"><div class="modal"><div class="modal-handle"></div><div class="modal-hdr"><h2 id="modalTitle"></h2><button class="modal-close" onclick="closeModal()">√ó</button></div><div id="modalContent"></div></div></div>
<div class="confirm-modal" id="confirmModal"><div class="confirm-box"><h3 id="confirmTitle">¬øEst√°s seguro?</h3><p id="confirmMsg"></p><div class="confirm-btns"><button class="cancel" onclick="closeConfirm()">Cancelar</button><button class="danger" id="confirmBtn">Eliminar</button></div></div></div>
<div class="toast" id="toast"></div>
<input type="file" id="fileInput" accept=".json" style="display:none">
<script>
const DB_NAME='HabitosDB',DB_VERSION=2;let db=null;
const COLORS=['#00d4ff','#00ff88','#ffee00','#ff8800','#ff00aa','#aa00ff','#00ffcc','#ff3366'];
const DAYS=['L','M','X','J','V','S','D'],MONTHS=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

const LS={_data:null,_load(){if(this._data)return this._data;try{this._data={habits:JSON.parse(localStorage.getItem('h_habits')||'[]'),records:JSON.parse(localStorage.getItem('h_records')||'[]'),nextId:parseInt(localStorage.getItem('h_nextId')||'1')}}catch{this._data={habits:[],records:[],nextId:1}}return this._data},_save(){try{localStorage.setItem('h_habits',JSON.stringify(this._data.habits));localStorage.setItem('h_records',JSON.stringify(this._data.records));localStorage.setItem('h_nextId',this._data.nextId.toString())}catch(e){}},getHabits(){return this._load().habits},addHabit(h){const d=this._load();h.id=d.nextId++;d.habits.push(h);this._save();return h.id},updateHabit(h){const d=this._load(),idx=d.habits.findIndex(x=>x.id===h.id);if(idx>=0)d.habits[idx]=h;this._save()},deleteHabit(id){const d=this._load();d.habits=d.habits.filter(h=>h.id!==id);d.records=d.records.filter(r=>r.habitId!==id);this._save()},getRecords(hid){return this._load().records.filter(r=>r.habitId===hid)},getAllRecords(){return this._load().records},getRecord(hid,date){return this._load().records.find(r=>r.habitId===hid&&r.date===date)||null},setRecord(hid,date,count){const d=this._load(),ex=d.records.find(r=>r.habitId===hid&&r.date===date);if(ex)ex.count=count;else d.records.push({id:d.nextId++,habitId:hid,date,count});this._save()}};

let useLS=false;
function initDB(){return new Promise(resolve=>{if(!window.indexedDB){useLS=true;resolve();return}try{const req=indexedDB.open(DB_NAME,DB_VERSION);req.onerror=()=>{useLS=true;resolve()};req.onsuccess=e=>{db=e.target.result;resolve()};req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('habits'))d.createObjectStore('habits',{keyPath:'id',autoIncrement:true});if(!d.objectStoreNames.contains('records')){const s=d.createObjectStore('records',{keyPath:'id',autoIncrement:true});s.createIndex('habitId','habitId');s.createIndex('habitDate',['habitId','date'],{unique:true})}}}catch{useLS=true;resolve()}})}

function dbOp(store,mode,fn){return new Promise((res,rej)=>{try{const tx=db.transaction(store,mode),s=tx.objectStore(store),r=fn(s);if(r&&r.onsuccess!==undefined){r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)}else{tx.oncomplete=()=>res(r);tx.onerror=()=>rej(tx.error)}}catch(e){rej(e)}})}

async function getHabits(){if(useLS)return LS.getHabits();return dbOp('habits','readonly',s=>s.getAll())}
async function addHabit(h){if(useLS)return LS.addHabit(h);return dbOp('habits','readwrite',s=>s.add(h))}
async function updateHabit(h){if(useLS)return LS.updateHabit(h);return dbOp('habits','readwrite',s=>s.put(h))}
async function deleteHabit(id){if(useLS)return LS.deleteHabit(id);const recs=await getRecsByHabit(id);for(const r of recs)await dbOp('records','readwrite',s=>s.delete(r.id));return dbOp('habits','readwrite',s=>s.delete(id))}
async function getRecsByHabit(hid){if(useLS)return LS.getRecords(hid);return dbOp('records','readonly',s=>s.index('habitId').getAll(hid))}
async function getAllRecs(){if(useLS)return LS.getAllRecords();return dbOp('records','readonly',s=>s.getAll())}
async function getRec(hid,date){if(useLS)return LS.getRecord(hid,date);return new Promise(res=>{try{const tx=db.transaction('records','readonly'),r=tx.objectStore('records').index('habitDate').get([hid,date]);r.onsuccess=()=>res(r.result||null);r.onerror=()=>res(null)}catch{res(null)}})}
async function setRec(hid,date,cnt){if(useLS)return LS.setRecord(hid,date,cnt);const ex=await getRec(hid,date);if(ex){ex.count=cnt;return dbOp('records','readwrite',s=>s.put(ex))}return dbOp('records','readwrite',s=>s.add({habitId:hid,date,count:cnt}))}

const fmtDate=d=>d.toISOString().split('T')[0];
const isToday=d=>fmtDate(d)===fmtDate(new Date());
const isFuture=d=>{const t=new Date();t.setHours(0,0,0,0);const c=new Date(d);c.setHours(0,0,0,0);return c>t};
const clamp=(v,mi,ma)=>Math.max(mi,Math.min(ma,v));
const getCount=rec=>rec&&typeof rec.count==='number'?rec.count:0;

function hexRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
function rgbHex(r,g,b){return'#'+[r,g,b].map(x=>Math.round(clamp(x,0,255)).toString(16).padStart(2,'0')).join('')}
function interp(c1,c2,f){const a=hexRgb(c1),b=hexRgb(c2);if(!a||!b)return c1;return rgbHex(a.r+(b.r-a.r)*f,a.g+(b.g-a.g)*f,a.b+(b.b-a.b)*f)}
function calcColor(h,cnt,mx,has){if(!has)return'#333';const base=h.color||'#00d4ff';if(h.type==='increase'){if(cnt===0)return'#ff3366';return interp(interp(base,'#fff',.7),base,Math.min(cnt/Math.max(mx,5),1))}else{if(cnt===0)return'#00ff88';return interp(base,interp(base,'#fff',.7),Math.min(cnt/Math.max(mx,5),1))}}
async function getMaxCnt(hid){const recs=await getRecsByHabit(hid);return recs.length?Math.max(...recs.map(r=>r.count),5):5}
function getWeekStart(d){const dt=new Date(d),day=dt.getDay(),diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);dt.setHours(0,0,0,0);return dt}
function toast(m){const t=document.getElementById('toast');if(!t)return;t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}

async function calcStreak(hid){const recs=await getRecsByHabit(hid),habs=await getHabits(),hab=habs.find(h=>h.id===hid);if(!recs.length||!hab)return{cur:0,best:0};const dm={};recs.forEach(r=>dm[r.date]=r.count);let cur=0,best=0,tmp=0;const chk=new Date();while(cur<365){const ds=fmtDate(chk),cnt=dm[ds],has=typeof cnt==='number',good=hab.type==='increase'?(cnt>0):(cnt===0);if(has&&good){cur++;chk.setDate(chk.getDate()-1)}else if(!has&&isToday(chk)){chk.setDate(chk.getDate()-1)}else break}const all=Object.keys(dm).sort();for(const d of all){const cnt=dm[d],good=hab.type==='increase'?(cnt>0):(cnt===0);if(good){tmp++;best=Math.max(best,tmp)}else tmp=0}return{cur,best}}
async function calcScore(date){const habs=(await getHabits()).filter(h=>!h.archived);if(!habs.length)return 0;const ds=fmtDate(date);let tot=0,mx=0;for(const h of habs){const rec=await getRec(h.id,ds),cnt=getCount(rec),goal=h.goalDaily||1;tot+=(h.type==='increase'?Math.min(cnt/goal,1):(cnt===0?1:Math.max(0,1-cnt/goal)))*100;mx+=100}return mx>0?Math.round(tot/mx*100):0}
async function calcGlobalStreak(){const habs=(await getHabits()).filter(h=>!h.archived);if(!habs.length)return 0;let streak=0;const chk=new Date();chk.setDate(chk.getDate()-1);while(streak<365){if(await calcScore(chk)>=70){streak++;chk.setDate(chk.getDate()-1)}else break}return streak}

let habits=[],selDay=new Date(),selWeek=new Date(),selMonth=new Date(),selYear=new Date().getFullYear();

function switchView(vid){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById(vid).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelector(`[data-view="${vid}"]`).classList.add('active');({viewDay:renderDay,viewWeek:renderWeek,viewMonth:renderMonth,viewYear:renderYear,viewSettings:renderSettings})[vid]()}

async function updateScore(){const score=await calcScore(selDay),gs=await calcGlobalStreak();document.getElementById('scoreVal').textContent=score;const col=score>=80?'#00ff88':score>=50?'#ffee00':'#ff3366';document.getElementById('scoreVal').style.textShadow=`0 0 20px ${col}`;document.getElementById('scoreCircle').style.background=`conic-gradient(${col} ${score*3.6}deg,#1e1e1e 0deg)`;document.getElementById('scoreDate').textContent=isToday(selDay)?'Hoy':selDay.toLocaleDateString('es-ES',{weekday:'short',day:'numeric'});document.getElementById('gStreak').textContent=`${gs} d√≠as`}

function changeDay(d){selDay.setDate(selDay.getDate()+d);renderDay()}
async function renderDay(){habits=await getHabits();await updateScore();const v=document.getElementById('viewDay'),ds=fmtDate(selDay),fut=isFuture(selDay),active=habits.filter(h=>!h.archived);let html=`<div class="day-nav"><button class="day-btn" onclick="changeDay(-1)">‚Üê</button><div class="day-title"><h2>${isToday(selDay)?'Hoy':selDay.toLocaleDateString('es-ES',{weekday:'long',day:'numeric'})}</h2><p>${selDay.toLocaleDateString('es-ES',{month:'long',year:'numeric'})}</p></div><button class="day-btn" onclick="changeDay(1)">‚Üí</button></div>`;if(!active.length){html+=`<div class="empty"><div class="empty-icon">üìä</div><h3>Sin h√°bitos</h3><p>A√±ade tu primer h√°bito</p><button class="btn" onclick="switchView('viewSettings')">Ir a Ajustes</button></div>`;v.innerHTML=html;return}let done=0,best=0;for(const h of active){const rec=await getRec(h.id,ds),cnt=getCount(rec),goal=h.goalDaily||1;if((h.type==='increase'&&cnt>=goal)||(h.type==='reduce'&&cnt===0))done++;const st=await calcStreak(h.id);best=Math.max(best,st.cur)}html+=`<div class="stats-row"><div class="stat-card ${done===active.length?'good':''}"><div class="stat-val">${done}/${active.length}</div><div class="stat-lbl">Completados</div></div><div class="stat-card"><div class="stat-val">üî•${best}</div><div class="stat-lbl">Mejor racha</div></div><div class="stat-card"><div class="stat-val">${active.length}</div><div class="stat-lbl">H√°bitos</div></div></div><div class="habit-list">`;for(const h of active){const rec=await getRec(h.id,ds),cnt=getCount(rec),mx=await getMaxCnt(h.id),col=calcColor(h,cnt,mx,rec!==null),st=await calcStreak(h.id),goal=h.goalDaily||1,met=h.type==='increase'?cnt>=goal:cnt===0;html+=`<div class="habit-card"><div class="habit-info"><div class="habit-dot" style="background:${h.color};color:${h.color}"></div><div class="habit-details"><div class="habit-name">${h.name}</div><div class="habit-meta"><span class="habit-badge ${h.type==='increase'?'inc':'red'}">${h.type==='increase'?'‚Üë':'‚Üì'}</span>${st.cur>0?`<span class="habit-streak">üî•${st.cur}</span>`:''}<span class="habit-goal ${met?'done':''}">Meta:${goal}</span></div></div></div><div class="habit-counter"><button class="cnt-btn minus" data-id="${h.id}" data-d="-1"${fut?' disabled':''}>‚àí</button><span class="cnt-val" style="color:${col}">${cnt}</span><button class="cnt-btn plus" data-id="${h.id}" data-d="1"${fut?' disabled':''}>+</button></div></div>`}html+='</div>';v.innerHTML=html;v.querySelectorAll('.cnt-btn').forEach(btn=>btn.addEventListener('click',function(){updCnt(parseInt(this.dataset.id),parseInt(this.dataset.d))}))}
async function updCnt(hid,d){const ds=fmtDate(selDay),rec=await getRec(hid,ds),newCnt=Math.max(0,getCount(rec)+d);await setRec(hid,ds,newCnt);renderDay()}

function changeWeek(d){selWeek.setDate(selWeek.getDate()+d*7);renderWeek()}
async function renderWeek(){habits=await getHabits();const v=document.getElementById('viewWeek'),active=habits.filter(h=>!h.archived),ws=getWeekStart(selWeek),we=new Date(ws);we.setDate(we.getDate()+6);let html=`<div class="cal-header"><button class="cal-btn" onclick="changeWeek(-1)">‚Üê</button><h2 class="cal-title">${ws.toLocaleDateString('es-ES',{day:'numeric',month:'short'})} - ${we.toLocaleDateString('es-ES',{day:'numeric',month:'short'})}</h2><button class="cal-btn" onclick="changeWeek(1)">‚Üí</button></div>`;if(!active.length){v.innerHTML=html+'<div class="empty"><p>Sin h√°bitos</p></div>';return}for(const hab of active){const mx=await getMaxCnt(hab.id);html+=`<div class="habit-hm"><div class="habit-hm-hdr"><div class="habit-dot" style="background:${hab.color};color:${hab.color}"></div><span class="habit-name">${hab.name}</span></div><div class="heatmap"><div class="hm-week">${DAYS.map(d=>`<div class="hm-lbl">${d}</div>`).join('')}</div><div class="hm-grid week">`;for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const ds=fmtDate(d),rec=await getRec(hab.id,ds),cnt=getCount(rec),has=rec!==null,fut=isFuture(d),col=calcColor(hab,cnt,mx,has);html+=`<div class="hm-cell${fut?' future':has?'':' nodata'}" style="background:${fut?'transparent':col}" onclick="goDay('${ds}')">${fut?'':cnt}</div>`}html+='</div></div></div>'}v.innerHTML=html}

function changeMonth(d){selMonth.setMonth(selMonth.getMonth()+d);renderMonth()}
async function renderMonth(){habits=await getHabits();const v=document.getElementById('viewMonth'),active=habits.filter(h=>!h.archived);let html=`<div class="cal-header"><button class="cal-btn" onclick="changeMonth(-1)">‚Üê</button><h2 class="cal-title">${selMonth.toLocaleDateString('es-ES',{month:'long',year:'numeric'})}</h2><button class="cal-btn" onclick="changeMonth(1)">‚Üí</button></div>`;if(!active.length){v.innerHTML=html+'<div class="empty"><p>Sin h√°bitos</p></div>';return}const yr=selMonth.getFullYear(),mo=selMonth.getMonth(),fd=new Date(yr,mo,1),ld=new Date(yr,mo+1,0);let sd=fd.getDay()-1;if(sd<0)sd=6;for(const hab of active){const mx=await getMaxCnt(hab.id);html+=`<div class="habit-hm"><div class="habit-hm-hdr"><div class="habit-dot" style="background:${hab.color};color:${hab.color}"></div><span class="habit-name">${hab.name}</span></div><div class="heatmap"><div class="hm-week">${DAYS.map(d=>`<div class="hm-lbl">${d}</div>`).join('')}</div><div class="hm-grid month">`;for(let i=0;i<sd;i++)html+='<div class="hm-cell empty"></div>';for(let day=1;day<=ld.getDate();day++){const d=new Date(yr,mo,day),ds=fmtDate(d),rec=await getRec(hab.id,ds),cnt=getCount(rec),has=rec!==null,fut=isFuture(d),col=calcColor(hab,cnt,mx,has);html+=`<div class="hm-cell${fut?' future':has?'':' nodata'}" style="background:${fut?'transparent':col}" onclick="goDay('${ds}')">${fut?'':cnt}</div>`}html+='</div></div></div>'}v.innerHTML=html}

function changeYear(d){selYear+=d;renderYear()}
async function renderYear(){habits=await getHabits();const v=document.getElementById('viewYear'),active=habits.filter(h=>!h.archived);let html=`<div class="cal-header"><button class="cal-btn" onclick="changeYear(-1)">‚Üê</button><h2 class="cal-title">${selYear}</h2><button class="cal-btn" onclick="changeYear(1)">‚Üí</button></div>`;if(!active.length){v.innerHTML=html+'<div class="empty"><p>Sin h√°bitos</p></div>';return}for(const hab of active){const mx=await getMaxCnt(hab.id),ys=new Date(selYear,0,1);let sd=ys.getDay()-1;if(sd<0)sd=6;html+=`<div class="habit-hm"><div class="habit-hm-hdr"><div class="habit-dot" style="background:${hab.color};color:${hab.color}"></div><span class="habit-name">${hab.name}</span></div><div class="heatmap" style="overflow-x:auto"><div class="yr-months">${MONTHS.map(m=>`<span class="yr-month">${m}</span>`).join('')}</div><div class="hm-grid year">`;const cd=new Date(ys);cd.setDate(cd.getDate()-sd);const ye=new Date(selYear,11,31);for(let w=0;w<53;w++){for(let d=0;d<7;d++){const ds=fmtDate(cd),inYr=cd.getFullYear()===selYear;if(!inYr||cd>ye)html+='<div class="hm-cell empty"></div>';else{const rec=await getRec(hab.id,ds),cnt=getCount(rec),has=rec!==null,fut=isFuture(cd),col=calcColor(hab,cnt,mx,has);html+=`<div class="hm-cell${fut?' future':has?'':' nodata'}" style="background:${fut?'transparent':col}"></div>`}cd.setDate(cd.getDate()+1)}}html+='</div></div></div>'}v.innerHTML=html}

function goDay(ds){selDay=new Date(ds);switchView('viewDay')}

async function renderSettings(){habits=await getHabits();const v=document.getElementById('viewSettings'),active=habits.filter(h=>!h.archived),archived=habits.filter(h=>h.archived);let html='<div class="set-sec"><h3>Mis H√°bitos</h3><div class="set-list">';if(!active.length)html+='<div class="empty" style="padding:20px"><p>Sin h√°bitos</p></div>';else for(const h of active)html+=`<div class="set-item" data-edit="${h.id}"><div class="set-item-info"><div class="set-item-color" style="background:${h.color}"></div><div class="set-item-details"><h4>${h.name}</h4><p>${h.type==='increase'?'‚Üë':'‚Üì'} Meta:${h.goalDaily||1}/d√≠a</p></div></div><span class="set-item-action">‚Üí</span></div>`;html+='</div><button class="add-btn" id="addHabitBtn">+ A√±adir</button></div>';if(archived.length){html+='<div class="set-sec"><h3>Archivados</h3><div class="set-list">';for(const h of archived)html+=`<div class="set-item" style="opacity:.5" data-edit="${h.id}"><div class="set-item-info"><div class="set-item-color" style="background:${h.color}"></div><div class="set-item-details"><h4>${h.name}</h4><p>Archivado</p></div></div><span class="set-item-action">‚Üí</span></div>`;html+='</div></div>'}html+=`<div class="set-sec"><h3>Datos</h3><div class="set-list"><div class="set-item" id="exportBtn"><div class="set-item-info"><div class="set-item-details"><h4>Exportar</h4><p>Copia de seguridad</p></div></div><span class="set-item-action">‚Üí</span></div><div class="set-item" id="importBtn"><div class="set-item-info"><div class="set-item-details"><h4>Importar</h4><p>Restaurar datos</p></div></div><span class="set-item-action">‚Üí</span></div></div></div>`;v.innerHTML=html;document.getElementById('addHabitBtn').addEventListener('click',openAdd);document.getElementById('exportBtn').addEventListener('click',exportData);document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('fileInput').click());v.querySelectorAll('[data-edit]').forEach(el=>el.addEventListener('click',()=>openEdit(parseInt(el.dataset.edit))))}

function openModal(){document.getElementById('modalBg').classList.add('active')}
function closeModal(){document.getElementById('modalBg').classList.remove('active')}
function openAdd(){document.getElementById('modalTitle').textContent='Nuevo h√°bito';document.getElementById('modalContent').innerHTML=getForm();setupForm();openModal()}
async function openEdit(id){const h=habits.find(x=>x.id===id);if(!h)return;document.getElementById('modalTitle').textContent='Editar';document.getElementById('modalContent').innerHTML=getForm(h);setupForm(h);openModal()}

function getForm(h=null){const isE=h!==null,col=h?.color||COLORS[0],type=h?.type||'increase';return`<form id="habitForm"><div class="form-group"><label>Nombre</label><input type="text" id="fName" value="${h?.name||''}" placeholder="Ej: Vasos de agua" required></div><div class="form-group"><label>Tipo</label><div class="type-sel"><div class="type-opt ${type==='increase'?'sel':''}" data-type="increase"><div class="type-opt-icon">‚Üë</div><div class="type-opt-lbl">Aumentar</div><div class="type-opt-desc">M√°s=mejor</div></div><div class="type-opt ${type==='reduce'?'sel':''}" data-type="reduce"><div class="type-opt-icon">‚Üì</div><div class="type-opt-lbl">Reducir</div><div class="type-opt-desc">Menos=mejor</div></div></div><input type="hidden" id="fType" value="${type}"></div><div class="form-group"><label>Meta diaria</label><input type="number" id="fGoalD" value="${h?.goalDaily||1}" min="0"></div><div class="form-group"><label>Color</label><div class="color-picker">${COLORS.map(c=>`<div class="color-opt ${c===col?'sel':''}" style="background:${c}" data-color="${c}"></div>`).join('')}</div><input type="hidden" id="fColor" value="${col}"></div>${isE?`<div class="form-group"><div class="chk-grp"><input type="checkbox" id="fArch" ${h.archived?'checked':''}><label>Archivar</label></div></div>`:''}<div class="form-actions">${isE?`<button type="button" class="btn-del" id="delBtn">Eliminar</button>`:''}<button type="button" class="btn-sec" id="cancelBtn">Cancelar</button><button type="submit" class="btn">${isE?'Guardar':'Crear'}</button></div></form>`}

function setupForm(h=null){document.querySelectorAll('.type-opt').forEach(el=>el.addEventListener('click',function(){document.querySelectorAll('.type-opt').forEach(o=>o.classList.remove('sel'));this.classList.add('sel');document.getElementById('fType').value=this.dataset.type}));document.querySelectorAll('.color-opt').forEach(el=>el.addEventListener('click',function(){document.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('sel'));this.classList.add('sel');document.getElementById('fColor').value=this.dataset.color}));document.getElementById('cancelBtn').addEventListener('click',closeModal);document.getElementById('habitForm').addEventListener('submit',e=>{e.preventDefault();saveHabit(h?h.id:null)});if(h)document.getElementById('delBtn').addEventListener('click',()=>showConfirm('¬øEliminar h√°bito?','Se borrar√°n todos los datos',()=>confirmDel(h.id)))}

async function saveHabit(id){const h={name:document.getElementById('fName').value.trim(),type:document.getElementById('fType').value,color:document.getElementById('fColor').value,goalDaily:parseInt(document.getElementById('fGoalD').value)||1,goalWeekly:7,goalMonthly:30,archived:document.getElementById('fArch')?.checked||false};if(!h.name){toast('Nombre requerido');return}if(id){h.id=id;await updateHabit(h);toast('Actualizado')}else{await addHabit(h);toast('Creado')}closeModal();renderSettings()}

function showConfirm(title,msg,onConfirm){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMsg').textContent=msg;document.getElementById('confirmBtn').onclick=()=>{closeConfirm();onConfirm()};document.getElementById('confirmModal').classList.add('active')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('active')}
async function confirmDel(id){await deleteHabit(id);toast('Eliminado');closeModal();renderSettings()}

async function exportData(){const habs=await getHabits(),recs=await getAllRecs();const blob=new Blob([JSON.stringify({v:2,habits:habs,records:recs},null,2)],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=`habitos-${fmtDate(new Date())}.json`;a.click();URL.revokeObjectURL(url);toast('Exportado')}

async function handleImport(e){const file=e.target.files[0];if(!file)return;try{const data=JSON.parse(await file.text());if(!data.habits)throw new Error('Formato inv√°lido');const ex=await getHabits();for(const h of ex)await deleteHabit(h.id);const idMap={};for(const h of data.habits){const old=h.id;delete h.id;idMap[old]=await addHabit(h)}for(const r of(data.records||[]))if(idMap[r.habitId])await setRec(idMap[r.habitId],r.date,r.count);toast('Importado');renderSettings()}catch(err){toast('Error: '+err.message)}e.target.value=''}

function regSW(){if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{})}

async function init(){try{await initDB();document.querySelectorAll('.nav-item').forEach(i=>i.addEventListener('click',()=>switchView(i.dataset.view)));document.getElementById('modalBg').addEventListener('click',e=>{if(e.target.id==='modalBg')closeModal()});document.getElementById('confirmModal').addEventListener('click',e=>{if(e.target.id==='confirmModal')closeConfirm()});document.getElementById('fileInput').addEventListener('change',handleImport);regSW();await renderDay()}catch(err){console.error('Init error:',err);document.getElementById('viewDay').innerHTML=`<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Error al iniciar</h3><p>${err.message}</p><button class="btn" onclick="location.reload()">Reintentar</button></div>`}}

if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
</script>
</body>
</html>
